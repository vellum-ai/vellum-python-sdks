# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build and Development Commands

### Setup
```bash
make setup  # Complete setup including Python, Poetry, dependencies, pre-commit hooks, Node, and Fern
```

### Testing
```bash
# Run all tests
make test

# Run tests for a specific file or directory
make test file=tests/workflows/

# Run a single test function
poetry run pytest tests/workflows/path/to/test_file.py::TestClass::test_function -v

# Run tests with coverage
make test-ci
```

### Linting and Formatting
```bash
# Auto-format code
make format  # Runs black and isort

# Type checking
make types  # Runs mypy

# Individual tools
poetry run black .
poetry run isort .
poetry run ruff check .
```

### SDK Generation
```bash
# Generate node definitions for workflows
make generate-node-definitions
```

## Architecture Overview

### Project Structure
This is a Python SDK for Vellum AI with two main components:

1. **Client SDK** (`src/vellum/client/`): Auto-generated low-level client for direct API interaction. **NEVER manually edit files here** - changes must be made in the generator repository.

2. **Workflows SDK** (`src/vellum/workflows/`): High-level framework for defining AI systems as executable graphs with:
   - Static graph definition with strict typing
   - Nodes as building blocks representing tasks
   - State management for sharing data between nodes
   - Streaming support for long-running operations
   - Human-in-the-loop capabilities via External Inputs
   - UI integration for visual editing and debugging

### Key Directories
- `src/vellum/client/`: Auto-generated API client (DO NOT MODIFY)
- `src/vellum/workflows/`: Workflows SDK implementation
- `src/vellum/evaluations/`: Evaluation framework components
- `ee/vellum_ee/`: Enterprise features including serialization
- `ee/vellum_cli/`: CLI tool implementation
- `ee/codegen/`: Code generation tools and configurations
- `tests/workflows/`: Integration tests for workflows
- `examples/workflows/`: Example workflow implementations

### Important Configuration Files
- `pyproject.toml`: Poetry dependencies and tool configurations
- `.fernignore`: Files excluded from Fern auto-generation
- `Makefile`: Common development commands

## Development Guidelines

### Dependency Management
Uses Poetry for dependency management. Virtual environment is located in `.venv/`. Python version is 3.9+.

### Testing Approach
- Unit tests: Place in `**/tests/` directories next to the code being tested
- Integration tests: Place in `tests/workflows/` for full workflow testing
- Enterprise tests: Place in `vellum_ee/**/tests/`
- Generated tests: `tests/client/` are auto-generated, do not modify

### Code Style
- Line length: 120 characters
- Formatter: Black with isort for imports
- Type checking: mypy with strict checking enabled
- Linting: ruff and flake8 with custom configurations

### Working with Auto-generated Code
Files not listed in `.fernignore` are auto-generated by Fern. Any changes to these files will be lost on the next generation. To modify generated code:
1. Check if the file is in `.fernignore`
2. If not, changes must be made in the generator repository
3. Common auto-generated areas: `src/vellum/client/`, API type definitions

### Git Workflow
- Main branch: `main`
- Feature branches should follow naming conventions
- Pre-commit hooks are configured for formatting and linting
- All tests must pass before merging

## Common Development Tasks

### Adding a New Workflow Node
1. Create node class in `src/vellum/workflows/nodes/`
2. Define inputs and outputs as nested classes
3. Implement the `run()` method
4. Add corresponding tests
5. Run `make generate-node-definitions` if needed

### Adding New Features to Workflows SDK (e.g., Services, Tool Definitions)
When adding major features like new services or tool definitions, follow this PR sequence pattern:

#### Phase 1: Foundation
1. **Introduce the Service/Core Component** (if applicable)
   - Add service class to `src/vellum/workflows/nodes/displayable/tool_calling_node/` or appropriate location
   - Include unit tests in same directory under `tests/`
   - Update dependencies in `pyproject.toml` if needed

#### Phase 2: Type Definitions
2. **Add Type Definition**
   - Add new type to `src/vellum/workflows/types/definition.py`
   - Update related type files (`core.py`, etc.)
   - Add type tests in `src/vellum/workflows/types/tests/`

#### Phase 3: Runtime Support
3. **Add Runtime Execution Support**
   - Update utility files (e.g., `src/vellum/workflows/nodes/displayable/tool_calling_node/utils.py`)
   - Add integration tests in `tests/workflows/<feature_name>/`
   - Create example workflow demonstrating the feature

#### Phase 4: Codegen Support
4. **Add Code Generation Support**
   - Update TypeScript codegen in `ee/codegen/src/`
   - Add codegen tests in `ee/codegen/src/__test__/nodes/`
   - Add snapshots for generated code
   - Add codegen integration fixtures in `ee/codegen_integration/fixtures/`

#### Phase 5: Serialization
5. **Add Serialization Support**
   - Add serialization tests in `ee/vellum_ee/workflows/display/tests/workflow_serialization/`
   - Ensure proper display data handling

#### Phase 6: Cleanup (if needed)
6. **Remove Dependencies/Refactor**
   - Clean up any temporary dependencies
   - Move components to appropriate locations (e.g., `src/vellum/workflows/integrations/`)

### Modifying the Client SDK
Do not modify `src/vellum/client/` directly. Changes must be backported to the generator repository.

### Running a Specific Test
```bash
poetry run pytest path/to/test_file.py::TestClass::test_method -v
```

### Debugging
Use `ipdb` for debugging (already in dev dependencies).
