Debug Session Started: Thu Oct  9 15:10:21 EDT 2025
Issue: APO-1860 - MapNode Output references are lost in serialization
---
Expected: JokeMap.Outputs.result should be preserved
Actual: JokeMap.Outputs.result becomes None after serialization
---

=== ROOT CAUSE IDENTIFIED ===
File: src/vellum/workflows/nodes/core/map_node/node.py
Method: __annotate_outputs_class__ (line 211)

The MapNode class was missing a crucial line that sets the OutputReference as an
attribute on the outputs class. This caused output.instance to be 'undefined' instead
of the proper OutputReference, which in turn caused serialization to produce None values.

Comparison with other nodes:
- BaseAdornmentNode: setattr(outputs_class, reference.name, reference)  ✓
- InlineSubworkflowNode: setattr(outputs_class, reference.name, reference)  ✓
- MapNode: MISSING THIS LINE  ✗

=== FIX APPLIED ===
Added one line to MapNode.__annotate_outputs_class__:
    setattr(outputs_class, reference.name, reference)

This ensures that when someone writes:
    class FilterJokes(BaseNode):
        jokes = JokeMap.Outputs.result

The 'result' output from JokeMap has its instance properly set to an OutputReference,
which allows the serialization code in base_node_display.py to create a proper
NODE_OUTPUT pointer instead of None.

=== VERIFICATION ===
- All existing MapNode serialization tests pass ✓
- MapNode reference serialization test passes ✓
- New comprehensive test matching APO-1860 scenario passes ✓

Result: jokes attribute now serializes as NODE_OUTPUT reference instead of None!
